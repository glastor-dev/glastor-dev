name: SonarQube

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

permissions:
  contents: read

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: Skip Sonar scan for forks/Dependabot
        if: >-
          ${{ github.event_name == 'pull_request' &&
              (github.event.pull_request.head.repo.full_name != github.repository || github.actor == 'dependabot[bot]') }}
        run: |
          echo "Skipping Sonar scan: secrets are not available for this event/actor."
          echo "event_name=${{ github.event_name }}"
          echo "actor=${{ github.actor }}"
          echo "repo=${{ github.repository }}"
          echo "pr_head_repo=${{ github.event.pull_request.head.repo.full_name }}"

      - name: Checkout
        if: >-
          ${{ github.event_name != 'pull_request' ||
              (github.event.pull_request.head.repo.full_name == github.repository && github.actor != 'dependabot[bot]') }}
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate Sonar configuration
        if: >-
          ${{ github.event_name != 'pull_request' ||
              (github.event.pull_request.head.repo.full_name == github.repository && github.actor != 'dependabot[bot]') }}
        shell: bash
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_KEY: ${{ vars.SONAR_PROJECT_KEY }}
          SONAR_HOST_URL: ${{ vars.SONAR_HOST_URL }}
          SONAR_ORGANIZATION: ${{ vars.SONAR_ORGANIZATION }}
        run: |
          echo "event_name=${{ github.event_name }}"
          echo "actor=${{ github.actor }}"
          echo "repo=${{ github.repository }}"
          if [[ -z "${SONAR_TOKEN}" ]]; then
            echo "::error::Missing required secret SONAR_TOKEN (Settings → Secrets and variables → Actions → Secrets)"
            exit 1
          fi
          if [[ -z "${SONAR_PROJECT_KEY}" ]]; then
            echo "::error::Missing required variable SONAR_PROJECT_KEY (Settings → Secrets and variables → Actions → Variables)"
            exit 1
          fi
          # Normalize host URL. Some UIs may accidentally set SONAR_HOST_URL to '--'.
          if [[ -z "${SONAR_HOST_URL}" || "${SONAR_HOST_URL}" == "--" ]]; then
            SONAR_HOST_URL_FINAL="https://sonarcloud.io"
            echo "::notice::SONAR_HOST_URL not set (or invalid); defaulting to ${SONAR_HOST_URL_FINAL}"
          else
            SONAR_HOST_URL_FINAL="${SONAR_HOST_URL}"
          fi

          if [[ ! "${SONAR_HOST_URL_FINAL}" =~ ^https?:// ]]; then
            echo "::error::Invalid SONAR_HOST_URL value: '${SONAR_HOST_URL_FINAL}'. It must start with http:// or https:// (or leave it empty for SonarCloud)."
            exit 1
          fi

          echo "sonar.projectKey=${SONAR_PROJECT_KEY}"
          if [[ -n "${SONAR_ORGANIZATION}" ]]; then
            echo "sonar.organization=${SONAR_ORGANIZATION}"
          fi

          if [[ "${SONAR_HOST_URL_FINAL}" == "https://sonarcloud.io" ]]; then
            if [[ -z "${SONAR_ORGANIZATION}" ]]; then
              echo "::error::Missing required variable SONAR_ORGANIZATION for SonarCloud (Settings → Secrets and variables → Actions → Variables)"
              exit 1
            fi
          fi

          SONAR_ARGS="-Dsonar.projectKey=${SONAR_PROJECT_KEY}"
          if [[ "${SONAR_HOST_URL_FINAL}" == "https://sonarcloud.io" ]]; then
            SONAR_ARGS+=" -Dsonar.organization=${SONAR_ORGANIZATION}"
          fi
          SONAR_ARGS+=" -Dsonar.sources=src"
          SONAR_ARGS+=" -Dsonar.tests=test"
          SONAR_ARGS+=" -Dsonar.exclusions=**/node_modules/**,**/.venv/**,**/images/**,**/bench/**,README*.md,**/*.md"
          SONAR_ARGS+=" -Dsonar.test.inclusions=test/**"
          SONAR_ARGS+=" -Dsonar.sourceEncoding=UTF-8"
          SONAR_ARGS+=" -Dsonar.verbose=true"

          echo "SONAR_HOST_URL_FINAL=${SONAR_HOST_URL_FINAL}" >> "${GITHUB_ENV}"
          echo "SONAR_ARGS=${SONAR_ARGS}" >> "${GITHUB_ENV}"

      - name: SonarQube Scan
        if: >-
          ${{ github.event_name != 'pull_request' ||
              (github.event.pull_request.head.repo.full_name == github.repository && github.actor != 'dependabot[bot]') }}
        uses: SonarSource/sonarqube-scan-action@v7.0.0
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ env.SONAR_HOST_URL_FINAL }}
        with:
          args: ${{ env.SONAR_ARGS }}
